<!doctype html>
<html>
	<head>
		<title>Game-off 2012</title>
		<link rel="stylesheet" href="/css/style.css" />
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Dosis:300,600|Ubuntu" />
		<script src="/js/utils.js"></script>
		<script src="/js/controls.js"></script>
		<script src="/js/ticker.js"></script>
		<script src="/js/two/vector.js"></script>
		<script src="/js/author.js"></script>
		<script src="/js/idset.js"></script>
		<script src="/js/direction.js"></script>
		<script src="/js/color.js"></script>
		<script src="/js/commit.js"></script>
		<script src="/js/diff.js"></script>
		<script src="/js/branch.js"></script>
		<script src="/js/keyboardbranch.js"></script>
		<script src="/js/randombranch.js"></script>
		<script src="/js/keyboardplayer.js"></script>
		<script src="/js/randomplayer.js"></script>
		<script src="/js/world.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	</head>
	<body>
		<div id="wrapper"><canvas id="canvas">If you can see this, your browser sucks</canvas></div>
		<div id="gameover" class="vertical-center" style="display: none">
			<div>
				<div class="box">
					<h1>The game is over!</h1>
					<a id="restart" href="#">Restart</a>
				</div>
			</div>
		</div>
		<div id="about" class="vertical-center">
			<div>
				<div class="box">
					<h1>Github game-off 2012</h1>
					<p>You're working on the coolest project ever. You want to grab as much of your competitors code as possible, without letting them get hold of yours.</p>
					<p>The red line is your revision graph. Direct it with <kbd>wasd</kbd>. Collide with another revision graph, and you'll merge in, giving your evil competitors all your awesome code! Try to get them to give their code to you by cutting them off</p>
					<p>In a fix? Push <kbd>e</kbd> to fork your repository to split your revision graph in two!<p>
					<a id="play" href="#">Play</a>
				</div>
			</div>
		</div>
		<div id="scores"></div>
		<script>

		var world, players, ticker;
		function newGame() {
			$('#about').hide();
			$('#gameover').hide();
			world = new World(24, 15);
			players = "green cyan blue".split(' ').map(function(c) {
				var x = Math.round(Math.random() * world.width);
				var y = Math.round(Math.random() * world.height);
				return new RandomPlayer(
					"CPU", Color[c](),
					world.get(x, y)
				)
			});
			players.push(
				new KeyboardPlayer(
					"You", Color.red(),
					world.get(5, 5)
				)
			)
			$('#scores').empty();
			players.forEach(function(p) {
				p.scoreBar = $('<div>').append(
					$('<span>').addClass('name').text(p.name),
					$('<span>').addClass('score').text('0').css({color: p.color})
				)
				$('#scores').append(p.scoreBar, " ")
			})

			ticker = new Ticker(function() {
				world.tick();

				players.forEach(function(player) {
					player.update();
				});

				players.forEach(function(player) {
					var written = 0;
					var used = 0;
					world.commits.forEach(function(c) {
						if(c.author == player) written++;
						if(c.users.contains(player)) used++;
					});

					// Score = 2*your commits + other's commits
					var others = used - written;
					player.scoreBar
						.attr({title: written+" written, "+others+" merged"})
						.find('.score')
							.text(2*written + others);
				});

				if(players.every(function(p) { return p.branches.length == 0; })) {
					ticker.stop();
					$('#gameover').show();
					$('#restart').one('click', newGame)
				}
			}, 0.5);
			ticker.start();
			return false;
		}


		var ctx = canvas.getContext('2d');
		ctx.globalCompositeOperation = 'destination-over'
		$(window).resize(function(){
			canvas.width  = $(canvas).width();
			canvas.height = $(canvas).height();
		}).resize();

		$(document)
			.keyup(Controls.keyUpHandler)
			.keydown(Controls.keyDownHandler);
		$('#play').click(newGame);
		function draw(t) {
			ctx.clearRect(0, 0, canvas.width, canvas.height);
			if(world && ticker) world.drawTo(ctx, ticker.progress());
			requestAnimationFrame(draw);
		}
		draw();

		</script>
	</body>
</html>